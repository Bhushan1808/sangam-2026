<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flappy (placeholder)</title>
<style>
  html,body{height:100%;margin:0;background:linear-gradient(#9be8ff,#70c5ce 60%);display:flex;align-items:center;justify-content:center;font-family:Inter, system-ui, -apple-system, sans-serif}
  #game{width:100%;max-width:820px;background:transparent;position:relative;border-radius:12px;overflow:hidden;box-shadow:0 18px 40px rgba(12,24,40,0.18)}
  canvas{display:block;width:100%;height:auto;background:linear-gradient(#9be8ff,#70c5ce 60%)}
  .hud{position:absolute;left:14px;top:14px;color:#fff;font-weight:800;text-shadow:0 3px 8px rgba(0,0,0,0.35);z-index:20}
  .score-pill{position:absolute;right:14px;top:14px;background:rgba(255,255,255,0.12);backdrop-filter:blur(6px);color:#fff;padding:8px 12px;border-radius:20px;font-weight:900;z-index:20;border:1px solid rgba(255,255,255,0.08)}
  .center{position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);text-align:center;color:#fff;z-index:20}
  button{padding:12px 18px;border-radius:12px;border:none;background:#fff;color:#1b1b1b;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.18)}
  #hud small{display:block;opacity:0.9;font-weight:600}
  /* small screens: larger tap targets */
  @media (max-width:420px){ button{padding:14px 20px;font-size:18px;border-radius:14px} .score-pill{padding:10px 14px} }
</style>
</head>
<body>
<div id="game">
  <canvas id="c" width="720" height="640"></canvas>
  <div class="hud" id="hud">Score: <span id="score">0</span></div>
  <div class="center" id="center">
    <h1 style="margin:0 0 8px 0">Flappy</h1>
    <div><button id="startBtn">Start</button></div>
  </div>
</div>
<script>
// Minimal Flappy-like implementation
(function(){
  const url = new URL(window.location.href);
  const player = url.searchParams.get('player') || 'Player';
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  // base design resolution
  const BASE_W = 720, BASE_H = 640;

  // responsive canvas sizing + high DPI (cap DPR to avoid huge buffers)
  function resizeCanvasToContainer(){
    const container = document.getElementById('game');
    const cw = Math.min(container.clientWidth, BASE_W);
    const ratio = BASE_H / BASE_W;
    const ch = Math.round(cw * ratio);
    // Cap devicePixelRatio to 2 to avoid creating very large canvases on hiDPI displays
    const rawDpr = window.devicePixelRatio || 1;
    const dpr = Math.max(1, Math.min(2, rawDpr));
    canvas.style.width = cw + 'px';
    canvas.style.height = ch + 'px';
    canvas.width = Math.round(cw * dpr);
    canvas.height = Math.round(ch * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  let W = BASE_W, H = BASE_H;
  function updateLogicalSize(){ const rect = canvas.getBoundingClientRect(); W = rect.width; H = rect.height; }
  resizeCanvasToContainer(); updateLogicalSize();
  window.addEventListener('resize', ()=>{ resizeCanvasToContainer(); updateLogicalSize(); });

  let frame = 0, score = 0, gameOver = false, started = false;

  // bird base values (scaled at runtime)
  const birdBase = { x: 140, y: BASE_H/2, w:34, h:24 };
  let bird = { x: birdBase.x, y: birdBase.y, vy:0, w:birdBase.w, h:birdBase.h };
  let gravity = 0.45, jump = -8.5;
  const pipes = [];

  function rand(min,max){ return Math.random()*(max-min)+min }

  function spawnPipe(){
    const gap = Math.max(90, Math.round(H * 0.22));
    const topH = rand(40, Math.max(80, H - 160 - gap));
    const tw = Math.max(48, Math.round(W * 0.08));
    pipes.push({ x: W + tw + 20, top: topH, gap, w: tw });
  }

  // clouds — layers for parallax (reduced count for performance)
  const clouds = [];
  function makeCloud(x,y,scale,alpha,layer){ return { x,y,scale,alpha,layer }; }
  function initClouds(){
    clouds.length = 0;
    const layers = 3;
    // fewer clouds reduces per-frame work on low-end devices
    const CLOUD_COUNT = 6;
    for(let i=0;i<CLOUD_COUNT;i++){
      const layer = 1 + (i%layers);
      clouds.push(makeCloud(Math.random()*W, Math.random()*H*0.45, 0.6+Math.random()*1.2, 0.35+Math.random()*0.5, layer));
    }
  }

  function computeScaledValues(){
    const scale = Math.max(0.5, W / BASE_W);
    bird.w = Math.max(20, Math.round(birdBase.w * scale));
    bird.h = Math.max(14, Math.round(birdBase.h * scale));
    bird.x = Math.max(56, Math.round(W * 0.18));
    gravity = 0.45 * Math.max(0.6, scale);
    jump = -8.5 * Math.max(0.6, scale);
  }

  function reset(){
    frame=0; score=0; gameOver=false; started=false; pipes.length=0;
    updateLogicalSize(); computeScaledValues(); bird.y = Math.round(H*0.45); bird.vy = 0;
    initClouds();
    document.getElementById('score').textContent = score;
    const startBtn = document.getElementById('startBtn'); if (startBtn) startBtn.textContent = 'Start';
    document.getElementById('center').style.display='block';
  }

  let rafId = null;
  function startGame(){
    const startBtn = document.getElementById('startBtn');
    if (gameOver) { reset(); }
    started = true; gameOver = false;
    document.getElementById('center').style.display='none';
    if (startBtn) startBtn.textContent = 'Pause';
    // Notify parent to switch to a lighter rendering mode
    try { parent.postMessage(JSON.stringify({ type: 'GAME_EVENT', event: 'start' }), '*'); } catch(e){ parent.postMessage({ type: 'GAME_EVENT', event: 'start' }, '*'); }
    if (!gameOver) {
      if (!rafId) rafId = requestAnimationFrame(loop);
    }
  }

  function pauseGame(){
    const startBtn = document.getElementById('startBtn');
    started = false;
    if (startBtn) startBtn.textContent = 'Resume';
    try { parent.postMessage(JSON.stringify({ type: 'GAME_EVENT', event: 'pause' }), '*'); } catch(e){ parent.postMessage({ type: 'GAME_EVENT', event: 'pause' }, '*'); }
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
  }

  function update(){
    if (!started) return;
    frame++;
    bird.vy += gravity; bird.y += bird.vy;
    if (frame % Math.max(60, Math.round(90 * (BASE_W / W))) === 0) spawnPipe();
    for (let i=pipes.length-1;i>=0;i--){
      const speed = Math.max(2.2, 2.6 + Math.min(2, score/50));
      pipes[i].x -= speed;
      if (pipes[i].x + (pipes[i].w||60) < 0) pipes.splice(i,1);
    }
    // collisions & scoring
    pipes.forEach(p=>{
      const pipeW = p.w || Math.max(48, Math.round(W * 0.08));
      if (!p.scored && p.x + pipeW < bird.x){ p.scored = true; score++; document.getElementById('score').textContent = score; }
      const bw = bird.w, bh = bird.h;
      const bx = bird.x, by = bird.y;
      const tx = p.x, ty = 0, tw = pipeW, th = p.top;
      const bx2 = bx + bw, by2 = by + bh;
      if (!(bx2 < tx || bx > tx+tw || by2 < ty || by > ty+th)) gameOver = true;
      const bpty = p.top + p.gap, bph = H - bpty;
      if (!(bx2 < tx || bx > tx+tw || by2 < bpty || by > bpty + bph)) gameOver = true;
    });
    // ground / ceiling
    if (bird.y + bird.h > H || bird.y < 0) gameOver = true;
    if (gameOver) endGame();
  }

  function endGame(){
    started = false;
    document.getElementById('center').style.display='block';
    const payload = { type: 'GAMESNACKS_SCORE_MESSAGE', score: score, scoreMetadata: { name: player } };
    try { parent.postMessage(JSON.stringify(payload), '*'); } catch(e){ parent.postMessage(payload,'*'); }
    // tell parent gameplay ended so it can re-enable effects
    try { parent.postMessage(JSON.stringify({ type: 'GAME_EVENT', event: 'end', score }), '*'); } catch(e){ parent.postMessage({ type: 'GAME_EVENT', event: 'end', score }, '*'); }
    const startBtn = document.getElementById('startBtn'); if (startBtn) startBtn.textContent = 'Restart';
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
  }

  function drawClouds(){
    // draw soft clouds behind everything
    clouds.forEach(c=>{
      const speed = 0.25 * c.layer;
      c.x -= speed;
      if (c.x < -120) c.x = W + 40;
      const cx = c.x, cy = c.y, s = 18 * c.scale;
      ctx.save(); ctx.globalAlpha = c.alpha;
      ctx.fillStyle = '#ffffff';
      // simple cloud blobs
      ctx.beginPath(); ctx.ellipse(cx, cy, s*1.6, s*1.0, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx + s*0.9, cy - s*0.4, s*1.2, s*0.9, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx - s*0.9, cy - s*0.3, s*1.1, s*0.85, 0, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    });
  }

  function draw(){
    // sky gradient background
    ctx.fillStyle = '#9be8ff'; ctx.fillRect(0,0,W,H);
    // clouds
    drawClouds();
    // pipes
    pipes.forEach(p=>{
      const pipeW = p.w || Math.max(48, Math.round(W * 0.08));
      // pipe body
      ctx.fillStyle = '#2d8f2d';
      roundRect(ctx, p.x, 0, pipeW, p.top, Math.max(4, pipeW*0.12)); ctx.fill();
      roundRect(ctx, p.x, p.top + p.gap, pipeW, H - (p.top + p.gap), Math.max(4, pipeW*0.12)); ctx.fill();
      // pipe cap
      ctx.fillStyle = '#218221'; ctx.fillRect(p.x - 2, p.top - 8, pipeW + 4, 8);
      ctx.fillRect(p.x - 2, p.top + p.gap, pipeW + 4, 8);
    });
    // bird (improved shape: body + head + beak + eye + flapping wing + tail)
    ctx.save();
    ctx.translate(bird.x + bird.w/2, bird.y + bird.h/2);
    const tilt = Math.max(-0.8, Math.min(0.8, bird.vy/8));
    ctx.rotate(tilt);
    const bw = bird.w, bh = bird.h;

    // body
    ctx.fillStyle = '#ffcc44';
    ctx.beginPath(); ctx.ellipse(0, 0, bw/2, bh/2, 0, 0, Math.PI*2); ctx.fill();

    // head (slightly forward)
    ctx.fillStyle = '#ffd95a';
    ctx.beginPath(); ctx.ellipse(bw*0.16, -bh*0.14, bw*0.28, bh*0.26, 0, 0, Math.PI*2); ctx.fill();

    // beak (triangle)
    ctx.fillStyle = '#ff8c2b';
    ctx.beginPath();
    ctx.moveTo(bw*0.40, -bh*0.06);
    ctx.lineTo(bw*0.70, -bh*0.02);
    ctx.lineTo(bw*0.40, bh*0.08);
    ctx.closePath(); ctx.fill();

    // eye (white + pupil)
    ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.arc(bw*0.24, -bh*0.20, Math.max(2, bw*0.06), 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#1b1b1b'; ctx.beginPath(); ctx.arc(bw*0.27, -bh*0.20, Math.max(1.2, bw*0.03), 0, Math.PI*2); ctx.fill();

    // flapping wings (two wings: near-wing and far-wing) — animate with phase for natural motion
    const flap = Math.sin(frame * 0.36) * Math.max(0.8, bw*0.08);
    // near wing (lower/front wing)
    ctx.save();
    ctx.translate(-bw*0.05, bh*0.06);
    ctx.rotate(-0.28 + flap * 0.03);
    ctx.fillStyle = '#f4c84f';
    ctx.beginPath(); ctx.ellipse(0, 0, bw*0.34, bh*0.20, -0.7, 0, Math.PI*2); ctx.fill();
    // wing highlight
    ctx.fillStyle = 'rgba(255,255,255,0.08)'; ctx.beginPath(); ctx.ellipse(-bw*0.06, -bh*0.02, bw*0.18, bh*0.08, -0.7, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    // far wing (upper/back wing) - slightly delayed/phase-shifted for realism
    ctx.save();
    ctx.translate(bw*0.12, -bh*0.02);
    ctx.rotate(0.48 - flap * 0.02);
    ctx.fillStyle = '#f0b84a';
    ctx.beginPath(); ctx.ellipse(0, 0, bw*0.28, bh*0.14, -0.5, 0, Math.PI*2); ctx.fill();
    // far wing shadow
    ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.beginPath(); ctx.ellipse(bw*0.02, bh*0.02, bw*0.16, bh*0.06, -0.5, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    // tail (small feathers)
    ctx.fillStyle = '#ffb84d';
    ctx.beginPath();
    ctx.moveTo(-bw*0.46, 0);
    ctx.lineTo(-bw*0.82, -bh*0.14);
    ctx.lineTo(-bw*0.82, bh*0.14);
    ctx.closePath(); ctx.fill();

    ctx.restore();
    // ground strip
    ctx.fillStyle = '#e6e6e6'; ctx.fillRect(0, H- Math.max(36, Math.round(H*0.07)), W, Math.max(36, Math.round(H*0.07)));
  }

  // helper: rounded rect path
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  function loop(){ update(); draw(); if (!gameOver) requestAnimationFrame(loop); }


  document.getElementById('startBtn').addEventListener('click', ()=>{
    // toggle play/pause/restart
    if (gameOver) { reset(); startGame(); return; }
    if (!started) { startGame(); } else { pauseGame(); }
  });

  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space' || e.key === ' ') {
      bird.vy = jump;
      if (!started) startGame();
    }
  });

  window.addEventListener('mousedown', ()=>{ bird.vy = jump; if (!started) startGame(); });

  // initialize
  reset();
})();
</script>
</body>
</html>